# Build agent binary (no frontend)
FROM golang:1.25-alpine AS agent-builder
ARG BUILD_TAGS="exclude_frontend"
WORKDIR /build

RUN apk add --no-cache git ca-certificates tzdata curl

COPY ./backend/go.mod ./backend/go.sum ./
RUN go mod download

COPY ./backend ./backend

# Build agent binary
WORKDIR /build/backend
RUN CGO_ENABLED=0 \
    GOOS=linux \
    go build \
    -tags "${BUILD_TAGS}" \
    -ldflags='-w -s' \
    -trimpath \
    -o /out/arcane-agent \
    ./cmd/main.go

ARG COMPOSE_VERSION=2.39.2
ARG TARGETARCH
RUN set -eux; \
    case "${TARGETARCH:-amd64}" in \
      amd64) ARCH=x86_64 ;; \
      arm64) ARCH=aarch64 ;; \
      *) ARCH="${TARGETARCH:-x86_64}" ;; \
    esac; \
    curl -fsSL -o /out/docker-compose "https://github.com/docker/compose/releases/download/v${COMPOSE_VERSION}/docker-compose-linux-${ARCH}"; \
    chmod +x /out/docker-compose

FROM alpine:3 AS agent
RUN apk --no-cache add ca-certificates tzdata curl su-exec

WORKDIR /app
RUN mkdir -p /app/data && chmod 755 /app/data

COPY --from=agent-builder /out/arcane-agent /usr/local/bin/arcane-agent
COPY --from=agent-builder /out/docker-compose /usr/local/bin/docker-compose

COPY --chmod=755 scripts/docker/entrypoint.sh /usr/local/bin/entrypoint.sh
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

ENV GIN_MODE=release \
    PORT=3553 \
    AGENT_MODE=true

ENV ENVIRONMENT=production

EXPOSE 3553
VOLUME ["/app/data"]

CMD ["/usr/local/bin/arcane-agent"]