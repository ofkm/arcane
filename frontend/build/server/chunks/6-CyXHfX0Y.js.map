{"version":3,"file":"6-CyXHfX0Y.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/auth/login/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/6.js"],"sourcesContent":["import { r as redirect, f as fail } from \"../../../../chunks/index.js\";\nimport { c as getUserByUsernameFromDb, v as verifyPassword } from \"../../../../chunks/user-service.js\";\nimport { g as getSettings } from \"../../../../chunks/settings-service.js\";\nconst load = async ({ locals, url }) => {\n  const session = locals.session.data;\n  const appSettings = await getSettings();\n  if (session?.userId) {\n    if (!appSettings.onboarding?.completed) {\n      throw redirect(302, \"/onboarding/welcome\");\n    } else {\n      throw redirect(302, \"/\");\n    }\n  }\n  const redirectTo = url.searchParams.get(\"redirect\") || \"/\";\n  const error = url.searchParams.get(\"error\");\n  return {\n    redirectTo,\n    settings: appSettings,\n    // Pass all settings to the page\n    error\n    // Pass error to the page\n  };\n};\nconst actions = {\n  login: async ({ request, locals }) => {\n    const formData = await request.formData();\n    const username = formData.get(\"username\")?.toString() || \"\";\n    const password = formData.get(\"password\")?.toString() || \"\";\n    const redirectTo = formData.get(\"redirectTo\")?.toString() || \"/\";\n    try {\n      const user = await getUserByUsernameFromDb(username);\n      if (!user) {\n        console.log(`User not found: ${username}`);\n        return fail(400, { error: \"Invalid username or password\", username, redirectTo });\n      }\n      const appSettings = await getSettings();\n      if (appSettings.auth?.localAuthEnabled === false) {\n        console.log(`Local login attempt for ${username} when local auth is disabled.`);\n        return fail(403, { error: \"Local login is disabled.\", username, redirectTo });\n      }\n      if (!user.passwordHash) {\n        console.log(`Local login attempt for OIDC-only user: ${username}`);\n        return fail(400, { error: \"This account must sign in via OIDC.\", username, redirectTo });\n      }\n      const passwordValid = await verifyPassword(user, password);\n      if (!passwordValid) {\n        console.log(\"Password verification failed\");\n        return fail(400, { error: \"Invalid username or password\", username, redirectTo });\n      }\n      try {\n        await locals.session.set({\n          userId: user.id,\n          username: user.username,\n          createdAt: Date.now(),\n          lastAccessed: Date.now()\n        });\n      } catch (sessionError) {\n        console.error(\"Session creation error:\", sessionError);\n        return fail(500, { error: \"Failed to create session.\", username, redirectTo });\n      }\n      return {\n        status: 302,\n        location: redirectTo\n      };\n    } catch (error) {\n      if (error instanceof Response && error.status === 302) throw error;\n      console.error(\"Login error details:\", error);\n      const errorMessage = error instanceof Error ? `Login failed: ${error.message}` : \"An error occurred during login\";\n      return fail(500, { error: errorMessage, username, redirectTo });\n    }\n  }\n};\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/auth/login/_page.server.ts.js';\n\nexport const index = 6;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/auth/login/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/auth/login/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/6.DHMys3EW.js\",\"_app/immutable/chunks/zguDtZw-.js\",\"_app/immutable/chunks/SIFgIYqZ.js\",\"_app/immutable/chunks/D4OMRqmI.js\",\"_app/immutable/chunks/BmbK19Nn.js\",\"_app/immutable/chunks/CU5Yr9hi.js\",\"_app/immutable/chunks/CCdH-GF7.js\",\"_app/immutable/chunks/CGNubMbN.js\",\"_app/immutable/chunks/hybYrdok.js\",\"_app/immutable/chunks/DsjzulNM.js\",\"_app/immutable/chunks/C7TZ37ch.js\",\"_app/immutable/chunks/87Ty6o0e.js\",\"_app/immutable/chunks/D1n4spDD.js\",\"_app/immutable/chunks/DUYgD2_s.js\",\"_app/immutable/chunks/BAOWbDue.js\",\"_app/immutable/chunks/Hi6OfGhB.js\",\"_app/immutable/chunks/m9ItHG6J.js\",\"_app/immutable/chunks/iMjrFJrG.js\",\"_app/immutable/chunks/C4qL6Mf1.js\",\"_app/immutable/chunks/CX4OS9M0.js\",\"_app/immutable/chunks/CVwLPvhk.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAGA,MAAM,IAAI,GAAG,OAAO,EAAE,MAAM,EAAE,GAAG,EAAE,KAAK;AACxC,EAAE,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC,IAAI;AACrC,EAAE,MAAM,WAAW,GAAG,MAAM,WAAW,EAAE;AACzC,EAAE,IAAI,OAAO,EAAE,MAAM,EAAE;AACvB,IAAI,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,SAAS,EAAE;AAC5C,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC;AAChD,KAAK,MAAM;AACX,MAAM,MAAM,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC;AAC9B;AACA;AACA,EAAE,MAAM,UAAU,GAAG,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,UAAU,CAAC,IAAI,GAAG;AAC5D,EAAE,MAAM,KAAK,GAAG,GAAG,CAAC,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC;AAC7C,EAAE,OAAO;AACT,IAAI,UAAU;AACd,IAAI,QAAQ,EAAE,WAAW;AACzB;AACA,IAAI;AACJ;AACA,GAAG;AACH,CAAC;AACD,MAAM,OAAO,GAAG;AAChB,EAAE,KAAK,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK;AACxC,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,CAAC,QAAQ,EAAE;AAC7C,IAAI,MAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE;AAC/D,IAAI,MAAM,QAAQ,GAAG,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE;AAC/D,IAAI,MAAM,UAAU,GAAG,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,EAAE,QAAQ,EAAE,IAAI,GAAG;AACpE,IAAI,IAAI;AACR,MAAM,MAAM,IAAI,GAAG,MAAM,uBAAuB,CAAC,QAAQ,CAAC;AAC1D,MAAM,IAAI,CAAC,IAAI,EAAE;AACjB,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,gBAAgB,EAAE,QAAQ,CAAC,CAAC,CAAC;AAClD,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,8BAA8B,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AACzF;AACA,MAAM,MAAM,WAAW,GAAG,MAAM,WAAW,EAAE;AAC7C,MAAM,IAAI,WAAW,CAAC,IAAI,EAAE,gBAAgB,KAAK,KAAK,EAAE;AACxD,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,wBAAwB,EAAE,QAAQ,CAAC,6BAA6B,CAAC,CAAC;AACvF,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,0BAA0B,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AACrF;AACA,MAAM,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;AAC9B,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,wCAAwC,EAAE,QAAQ,CAAC,CAAC,CAAC;AAC1E,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,qCAAqC,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AAChG;AACA,MAAM,MAAM,aAAa,GAAG,MAAM,cAAc,CAAC,IAAI,EAAE,QAAQ,CAAC;AAChE,MAAM,IAAI,CAAC,aAAa,EAAE;AAC1B,QAAQ,OAAO,CAAC,GAAG,CAAC,8BAA8B,CAAC;AACnD,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,8BAA8B,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AACzF;AACA,MAAM,IAAI;AACV,QAAQ,MAAM,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC;AACjC,UAAU,MAAM,EAAE,IAAI,CAAC,EAAE;AACzB,UAAU,QAAQ,EAAE,IAAI,CAAC,QAAQ;AACjC,UAAU,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;AAC/B,UAAU,YAAY,EAAE,IAAI,CAAC,GAAG;AAChC,SAAS,CAAC;AACV,OAAO,CAAC,OAAO,YAAY,EAAE;AAC7B,QAAQ,OAAO,CAAC,KAAK,CAAC,yBAAyB,EAAE,YAAY,CAAC;AAC9D,QAAQ,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,2BAA2B,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AACtF;AACA,MAAM,OAAO;AACb,QAAQ,MAAM,EAAE,GAAG;AACnB,QAAQ,QAAQ,EAAE;AAClB,OAAO;AACP,KAAK,CAAC,OAAO,KAAK,EAAE;AACpB,MAAM,IAAI,KAAK,YAAY,QAAQ,IAAI,KAAK,CAAC,MAAM,KAAK,GAAG,EAAE,MAAM,KAAK;AACxE,MAAM,OAAO,CAAC,KAAK,CAAC,sBAAsB,EAAE,KAAK,CAAC;AAClD,MAAM,MAAM,YAAY,GAAG,KAAK,YAAY,KAAK,GAAG,CAAC,cAAc,EAAE,KAAK,CAAC,OAAO,CAAC,CAAC,GAAG,gCAAgC;AACvH,MAAM,OAAO,IAAI,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,YAAY,EAAE,QAAQ,EAAE,UAAU,EAAE,CAAC;AACrE;AACA;AACA,CAAC;;;;;;;;ACrEW,MAAC,KAAK,GAAG;AACrB,IAAI,eAAe;AACP,MAAC,SAAS,GAAG,YAAY,eAAe,KAAK,CAAC,MAAM,OAAO,4BAA6C,CAAC,EAAE;AAE3G,MAAC,SAAS,GAAG;AACb,MAAC,OAAO,GAAG,CAAC,oCAAoC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC,CAAC,mCAAmC;AAChwB,MAAC,WAAW,GAAG;AACf,MAAC,KAAK,GAAG;;;;"}