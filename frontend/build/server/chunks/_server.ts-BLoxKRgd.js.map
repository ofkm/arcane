{"version":3,"file":"_server.ts-BLoxKRgd.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/users/_id_/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../chunks/index.js\";\nimport { a as getUserById, h as hashPassword, s as saveUser, d as deleteUserFromDb } from \"../../../../../chunks/user-service.js\";\nimport \"../../../../../chunks/settings-service.js\";\nimport { A as ApiErrorCode } from \"../../../../../chunks/errors.type.js\";\nimport { t as tryCatch } from \"../../../../../chunks/try-catch.js\";\nconst PUT = async ({ request, params, locals }) => {\n  try {\n    const userId = params.id;\n    if (!userId) {\n      return json({ success: false, error: \"User ID is required\" }, { status: 400 });\n    }\n    const bodyResult = await tryCatch(request.json());\n    if (bodyResult.error) {\n      return json({ success: false, error: \"Invalid JSON payload\" }, { status: 400 });\n    }\n    const { username, displayName, email, roles, password } = bodyResult.data;\n    const existingUser = await getUserById(userId);\n    if (!existingUser) {\n      return json({ success: false, error: \"User not found\" }, { status: 404 });\n    }\n    const updatedUser = {\n      ...existingUser,\n      ...username !== void 0 && { username },\n      ...displayName !== void 0 && { displayName },\n      ...email !== void 0 && { email },\n      ...roles !== void 0 && { roles },\n      updatedAt: (/* @__PURE__ */ new Date()).toISOString()\n    };\n    if (password) {\n      updatedUser.passwordHash = await hashPassword(password);\n    }\n    await saveUser(updatedUser);\n    return json({\n      success: true,\n      user: {\n        ...updatedUser,\n        passwordHash: void 0\n      }\n    });\n  } catch (error) {\n    console.error(\"Error updating user:\", error);\n    return json({ success: false, error: \"Failed to update user\" }, { status: 500 });\n  }\n};\nconst DELETE = async ({ params, locals }) => {\n  if (!locals.user || !locals.user.roles.includes(\"admin\")) {\n    const response = {\n      success: false,\n      error: \"Unauthorized\",\n      code: ApiErrorCode.FORBIDDEN\n    };\n    return json(response, { status: 403 });\n  }\n  const userId = params.id;\n  if (userId === locals.user.id) {\n    const response = {\n      success: false,\n      error: \"Cannot delete your own account\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  try {\n    const existingUser = await getUserById(userId);\n    if (!existingUser) {\n      const response = {\n        success: false,\n        error: \"User not found\",\n        code: ApiErrorCode.NOT_FOUND\n      };\n      return json(response, { status: 404 });\n    }\n    const deleteResult = await tryCatch(deleteUserFromDb(userId));\n    if (deleteResult.error) {\n      console.error(\"Error deleting user from database:\", deleteResult.error);\n      const response = {\n        success: false,\n        error: \"Failed to delete user\",\n        code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n        details: deleteResult.error\n      };\n      return json(response, { status: 500 });\n    }\n    return json({ success: true });\n  } catch (error) {\n    console.error(\"Error deleting user:\", error);\n    const response = {\n      success: false,\n      error: \"Failed to delete user\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: error\n    };\n    return json(response, { status: 500 });\n  }\n};\nexport {\n  DELETE,\n  PUT\n};\n"],"names":[],"mappings":"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"}