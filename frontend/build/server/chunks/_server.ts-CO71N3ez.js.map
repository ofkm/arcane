{"version":3,"file":"_server.ts-CO71N3ez.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/users/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { l as listUsers, g as getUserByUsername, h as hashPassword, s as saveUser } from \"../../../../chunks/user-service.js\";\nimport { g as getSettings } from \"../../../../chunks/settings-service.js\";\nimport { A as ApiErrorCode } from \"../../../../chunks/errors.type.js\";\nimport { t as tryCatch } from \"../../../../chunks/try-catch.js\";\nimport { nanoid } from \"nanoid\";\nconst GET = async ({ locals }) => {\n  if (!locals.user || !locals.user.roles.includes(\"admin\")) {\n    const response = {\n      success: false,\n      error: \"Unauthorized\",\n      code: ApiErrorCode.FORBIDDEN\n    };\n    return json(response, { status: 403 });\n  }\n  const usersResult = await tryCatch(listUsers());\n  if (usersResult.error) {\n    console.error(\"Error listing users:\", usersResult.error);\n    const response = {\n      success: false,\n      error: \"Failed to list users\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: usersResult.error\n    };\n    return json(response, { status: 500 });\n  }\n  const sanitizedUsers = usersResult.data.map((user) => {\n    const { passwordHash, ...rest } = user;\n    return rest;\n  });\n  return json({ success: true, users: sanitizedUsers });\n};\nconst POST = async ({ request, locals }) => {\n  const currentUser = locals.user;\n  if (!currentUser || !currentUser.roles.includes(\"admin\")) {\n    const response = {\n      success: false,\n      error: \"Unauthorized\",\n      code: ApiErrorCode.FORBIDDEN\n    };\n    return json(response, { status: 403 });\n  }\n  const userDataResult = await tryCatch(request.json());\n  if (userDataResult.error) {\n    const response = {\n      success: false,\n      error: \"Invalid JSON payload\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const { username, password, displayName, email, roles } = userDataResult.data;\n  if (!username || !password) {\n    const response = {\n      success: false,\n      error: \"Username and password are required\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const existingUserResult = await tryCatch(getUserByUsername(username));\n  if (existingUserResult.data) {\n    const response = {\n      success: false,\n      error: \"Username already exists\",\n      code: ApiErrorCode.CONFLICT\n    };\n    return json(response, { status: 409 });\n  }\n  const settingsResult = await tryCatch(getSettings());\n  const settings = settingsResult.data;\n  const policy = settings?.auth?.passwordPolicy || \"strong\";\n  if (!validatePassword(password, policy)) {\n    const response = {\n      success: false,\n      error: \"Password does not meet requirements\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const hashResult = await tryCatch(hashPassword(password));\n  if (hashResult.error) {\n    console.error(\"Error hashing password:\", hashResult.error);\n    const response = {\n      success: false,\n      error: \"Failed to hash password\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: hashResult.error\n    };\n    return json(response, { status: 500 });\n  }\n  const newUser = {\n    id: nanoid(),\n    // Generate a unique ID\n    username,\n    passwordHash: hashResult.data,\n    displayName: displayName || username,\n    email,\n    roles: roles || [\"user\"],\n    createdAt: (/* @__PURE__ */ new Date()).toISOString()\n  };\n  const saveResult = await tryCatch(saveUser(newUser));\n  if (saveResult.error) {\n    console.error(\"Error saving user:\", saveResult.error);\n    const response = {\n      success: false,\n      error: \"Failed to create user\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: saveResult.error\n    };\n    return json(response, { status: 500 });\n  }\n  const { passwordHash: _unused, ...sanitizedUser } = saveResult.data;\n  return json({\n    success: true,\n    user: sanitizedUser\n  });\n};\nfunction validatePassword(password, policy) {\n  switch (policy) {\n    case \"basic\":\n      return password.length >= 8;\n    case \"standard\":\n      return password.length >= 10 && /[A-Z]/.test(password) && /[0-9]/.test(password);\n    case \"strong\":\n      return password.length >= 12 && /[A-Z]/.test(password) && /[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password);\n    default:\n      return true;\n  }\n}\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}