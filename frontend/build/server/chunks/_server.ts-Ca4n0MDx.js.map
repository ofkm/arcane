{"version":3,"file":"_server.ts-Ca4n0MDx.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/settings/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { g as getSettings, s as saveSettings } from \"../../../../chunks/settings-service.js\";\nimport { initComposeService } from \"../../../../chunks/stack-custom-service.js\";\nimport { stopAutoUpdateScheduler, initAutoUpdateScheduler } from \"../../../../chunks/scheduler-service.js\";\nimport { A as ApiErrorCode } from \"../../../../chunks/errors.type.js\";\nimport { t as tryCatch } from \"../../../../chunks/try-catch.js\";\nimport { u as updateSettingsStore } from \"../../../../chunks/settings-store.js\";\nimport { d as dockerHost, u as updateDockerConnection } from \"../../../../chunks/core.js\";\nconst GET = async () => {\n  const result = await tryCatch(getSettings());\n  if (result.error) {\n    console.error(\"API Error fetching settings:\", result.error);\n    const response = {\n      success: false,\n      error: result.error.message || \"Failed to fetch settings\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: result.error\n    };\n    return json(response, { status: 500 });\n  }\n  return json({ success: true, settings: result.data });\n};\nconst PUT = async ({ request }) => {\n  const bodyResult = await tryCatch(request.json());\n  if (bodyResult.error) {\n    const response = {\n      success: false,\n      error: \"Invalid JSON payload\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const newSettingsData = bodyResult.data;\n  if (!newSettingsData.dockerHost) {\n    const response = {\n      success: false,\n      error: \"Docker host cannot be empty.\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  if (!newSettingsData.stacksDirectory) {\n    const response = {\n      success: false,\n      error: \"Stacks directory cannot be empty.\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const booleanFields = [\"autoUpdate\", \"pollingEnabled\"];\n  booleanFields.forEach((field) => {\n    const currentValue = newSettingsData[field];\n    if (typeof currentValue === \"string\") {\n      newSettingsData[field] = currentValue.toLowerCase() === \"true\";\n    }\n  });\n  if (newSettingsData.auth) {\n    const nestedAuthBooleanFields = [\"localAuthEnabled\", \"rbacEnabled\"];\n    nestedAuthBooleanFields.forEach((field) => {\n      if (Object.prototype.hasOwnProperty.call(newSettingsData.auth, field)) {\n        const currentValue = newSettingsData.auth[field];\n        if (typeof currentValue === \"string\") {\n          newSettingsData.auth[field] = currentValue.toLowerCase() === \"true\";\n        }\n      }\n    });\n  }\n  if (newSettingsData.pollingEnabled) {\n    const pollingInterval = parseInt(String(newSettingsData.pollingInterval), 10);\n    if (isNaN(pollingInterval) || pollingInterval < 5 || pollingInterval > 60) {\n      const response = {\n        success: false,\n        error: \"Polling interval must be between 5 and 60 minutes.\",\n        code: ApiErrorCode.BAD_REQUEST\n      };\n      return json(response, { status: 400 });\n    }\n    newSettingsData.pollingInterval = pollingInterval;\n  }\n  if (newSettingsData.autoUpdate) {\n    const autoUpdateInterval = parseInt(String(newSettingsData.autoUpdateInterval), 10);\n    if (isNaN(autoUpdateInterval) || autoUpdateInterval < 5) {\n      const response = {\n        success: false,\n        error: \"Auto-update interval must be at least 5 minutes.\",\n        code: ApiErrorCode.BAD_REQUEST\n      };\n      return json(response, { status: 400 });\n    }\n    newSettingsData.autoUpdateInterval = autoUpdateInterval;\n  }\n  const maturityThresholdDays = parseInt(String(newSettingsData.maturityThresholdDays), 10);\n  if (isNaN(maturityThresholdDays) || maturityThresholdDays < 1 || maturityThresholdDays > 365) {\n    const response = {\n      success: false,\n      error: \"Maturity threshold must be between 1 and 365 days.\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  newSettingsData.maturityThresholdDays = maturityThresholdDays;\n  const saveResult = await tryCatch(saveSettings(newSettingsData));\n  if (saveResult.error) {\n    console.error(\"API Error saving settings:\", saveResult.error);\n    const response = {\n      success: false,\n      error: saveResult.error.message || \"Failed to save settings\",\n      code: ApiErrorCode.INTERNAL_SERVER_ERROR,\n      details: saveResult.error\n    };\n    return json(response, { status: 500 });\n  }\n  console.log(\"API: Settings saved to disk successfully.\");\n  updateSettingsStore(newSettingsData);\n  console.log(\"API: Server-side settingsStore updated.\");\n  const newDockerHost = newSettingsData.dockerHost;\n  if (newDockerHost && newDockerHost !== dockerHost) {\n    console.log(`API: Docker host changed from \"${dockerHost}\" to \"${newDockerHost}\". Updating Docker connection.`);\n    updateDockerConnection(newDockerHost);\n  } else if (newDockerHost) {\n    console.log(`API: Docker host \"${newDockerHost}\" is the same as current \"${dockerHost}\". No Docker connection update forced from API.`);\n  }\n  await tryCatch(initComposeService());\n  await tryCatch(stopAutoUpdateScheduler());\n  if (newSettingsData.autoUpdate) {\n    await tryCatch(initAutoUpdateScheduler());\n  }\n  return json({ success: true, message: \"Settings updated successfully\" });\n};\nexport {\n  GET,\n  PUT\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQK,MAAC,GAAG,GAAG,YAAY;AACxB,EAAE,MAAM,MAAM,GAAG,MAAM,QAAQ,CAAC,WAAW,EAAE,CAAC;AAC9C,EAAE,IAAI,MAAM,CAAC,KAAK,EAAE;AACpB,IAAI,OAAO,CAAC,KAAK,CAAC,8BAA8B,EAAE,MAAM,CAAC,KAAK,CAAC;AAC/D,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC,OAAO,IAAI,0BAA0B;AAC/D,MAAM,IAAI,EAAE,YAAY,CAAC,qBAAqB;AAC9C,MAAM,OAAO,EAAE,MAAM,CAAC;AACtB,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,CAAC,IAAI,EAAE,CAAC;AACvD;AACK,MAAC,GAAG,GAAG,OAAO,EAAE,OAAO,EAAE,KAAK;AACnC,EAAE,MAAM,UAAU,GAAG,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;AACnD,EAAE,IAAI,UAAU,CAAC,KAAK,EAAE;AACxB,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,sBAAsB;AACnC,MAAM,IAAI,EAAE,YAAY,CAAC;AACzB,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,MAAM,eAAe,GAAG,UAAU,CAAC,IAAI;AACzC,EAAE,IAAI,CAAC,eAAe,CAAC,UAAU,EAAE;AACnC,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,8BAA8B;AAC3C,MAAM,IAAI,EAAE,YAAY,CAAC;AACzB,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,IAAI,CAAC,eAAe,CAAC,eAAe,EAAE;AACxC,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,mCAAmC;AAChD,MAAM,IAAI,EAAE,YAAY,CAAC;AACzB,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,MAAM,aAAa,GAAG,CAAC,YAAY,EAAE,gBAAgB,CAAC;AACxD,EAAE,aAAa,CAAC,OAAO,CAAC,CAAC,KAAK,KAAK;AACnC,IAAI,MAAM,YAAY,GAAG,eAAe,CAAC,KAAK,CAAC;AAC/C,IAAI,IAAI,OAAO,YAAY,KAAK,QAAQ,EAAE;AAC1C,MAAM,eAAe,CAAC,KAAK,CAAC,GAAG,YAAY,CAAC,WAAW,EAAE,KAAK,MAAM;AACpE;AACA,GAAG,CAAC;AACJ,EAAE,IAAI,eAAe,CAAC,IAAI,EAAE;AAC5B,IAAI,MAAM,uBAAuB,GAAG,CAAC,kBAAkB,EAAE,aAAa,CAAC;AACvE,IAAI,uBAAuB,CAAC,OAAO,CAAC,CAAC,KAAK,KAAK;AAC/C,MAAM,IAAI,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,eAAe,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE;AAC7E,QAAQ,MAAM,YAAY,GAAG,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC;AACxD,QAAQ,IAAI,OAAO,YAAY,KAAK,QAAQ,EAAE;AAC9C,UAAU,eAAe,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,YAAY,CAAC,WAAW,EAAE,KAAK,MAAM;AAC7E;AACA;AACA,KAAK,CAAC;AACN;AACA,EAAE,IAAI,eAAe,CAAC,cAAc,EAAE;AACtC,IAAI,MAAM,eAAe,GAAG,QAAQ,CAAC,MAAM,CAAC,eAAe,CAAC,eAAe,CAAC,EAAE,EAAE,CAAC;AACjF,IAAI,IAAI,KAAK,CAAC,eAAe,CAAC,IAAI,eAAe,GAAG,CAAC,IAAI,eAAe,GAAG,EAAE,EAAE;AAC/E,MAAM,MAAM,QAAQ,GAAG;AACvB,QAAQ,OAAO,EAAE,KAAK;AACtB,QAAQ,KAAK,EAAE,oDAAoD;AACnE,QAAQ,IAAI,EAAE,YAAY,CAAC;AAC3B,OAAO;AACP,MAAM,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC5C;AACA,IAAI,eAAe,CAAC,eAAe,GAAG,eAAe;AACrD;AACA,EAAE,IAAI,eAAe,CAAC,UAAU,EAAE;AAClC,IAAI,MAAM,kBAAkB,GAAG,QAAQ,CAAC,MAAM,CAAC,eAAe,CAAC,kBAAkB,CAAC,EAAE,EAAE,CAAC;AACvF,IAAI,IAAI,KAAK,CAAC,kBAAkB,CAAC,IAAI,kBAAkB,GAAG,CAAC,EAAE;AAC7D,MAAM,MAAM,QAAQ,GAAG;AACvB,QAAQ,OAAO,EAAE,KAAK;AACtB,QAAQ,KAAK,EAAE,kDAAkD;AACjE,QAAQ,IAAI,EAAE,YAAY,CAAC;AAC3B,OAAO;AACP,MAAM,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC5C;AACA,IAAI,eAAe,CAAC,kBAAkB,GAAG,kBAAkB;AAC3D;AACA,EAAE,MAAM,qBAAqB,GAAG,QAAQ,CAAC,MAAM,CAAC,eAAe,CAAC,qBAAqB,CAAC,EAAE,EAAE,CAAC;AAC3F,EAAE,IAAI,KAAK,CAAC,qBAAqB,CAAC,IAAI,qBAAqB,GAAG,CAAC,IAAI,qBAAqB,GAAG,GAAG,EAAE;AAChG,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,oDAAoD;AACjE,MAAM,IAAI,EAAE,YAAY,CAAC;AACzB,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,eAAe,CAAC,qBAAqB,GAAG,qBAAqB;AAC/D,EAAE,MAAM,UAAU,GAAG,MAAM,QAAQ,CAAC,YAAY,CAAC,eAAe,CAAC,CAAC;AAClE,EAAE,IAAI,UAAU,CAAC,KAAK,EAAE;AACxB,IAAI,OAAO,CAAC,KAAK,CAAC,4BAA4B,EAAE,UAAU,CAAC,KAAK,CAAC;AACjE,IAAI,MAAM,QAAQ,GAAG;AACrB,MAAM,OAAO,EAAE,KAAK;AACpB,MAAM,KAAK,EAAE,UAAU,CAAC,KAAK,CAAC,OAAO,IAAI,yBAAyB;AAClE,MAAM,IAAI,EAAE,YAAY,CAAC,qBAAqB;AAC9C,MAAM,OAAO,EAAE,UAAU,CAAC;AAC1B,KAAK;AACL,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC1C;AACA,EAAE,OAAO,CAAC,GAAG,CAAC,2CAA2C,CAAC;AAC1D,EAAE,mBAAmB,CAAC,eAAe,CAAC;AACtC,EAAE,OAAO,CAAC,GAAG,CAAC,yCAAyC,CAAC;AACxD,EAAE,MAAM,aAAa,GAAG,eAAe,CAAC,UAAU;AAClD,EAAE,IAAI,aAAa,IAAI,aAAa,KAAK,UAAU,EAAE;AACrD,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC,+BAA+B,EAAE,UAAU,CAAC,MAAM,EAAE,aAAa,CAAC,8BAA8B,CAAC,CAAC;AACnH,IAAI,sBAAsB,CAAC,aAAa,CAAC;AACzC,GAAG,MAAM,IAAI,aAAa,EAAE;AAC5B,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC,kBAAkB,EAAE,aAAa,CAAC,0BAA0B,EAAE,UAAU,CAAC,+CAA+C,CAAC,CAAC;AAC3I;AACA,EAAE,MAAM,QAAQ,CAAC,kBAAkB,EAAE,CAAC;AACtC,EAAE,MAAM,QAAQ,CAAC,uBAAuB,EAAE,CAAC;AAC3C,EAAE,IAAI,eAAe,CAAC,UAAU,EAAE;AAClC,IAAI,MAAM,QAAQ,CAAC,uBAAuB,EAAE,CAAC;AAC7C;AACA,EAAE,OAAO,IAAI,CAAC,EAAE,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,+BAA+B,EAAE,CAAC;AAC1E;;;;"}