{"version":3,"file":"_server.ts-CaMl-e_z.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/agents/_agentId_/deploy/stack/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../../../chunks/index.js\";\nimport { g as getAgent, s as sendTaskToAgent, e as createStackDeployment } from \"../../../../../../../chunks/agent-manager.js\";\nconst POST = async ({ locals, params, request }) => {\n  if (!locals.user?.roles.includes(\"admin\")) {\n    return json({ error: \"Unauthorized\" }, { status: 403 });\n  }\n  try {\n    const data = await request.json();\n    const agentId = params.agentId;\n    const { stackName, composeContent, envContent, mode } = data;\n    if (!stackName || !composeContent) {\n      return json({ error: \"Stack name and compose content are required\" }, { status: 400 });\n    }\n    const agent = await getAgent(agentId);\n    if (!agent) {\n      return json({ error: \"Agent not found\" }, { status: 404 });\n    }\n    if (agent.status !== \"online\") {\n      return json({ error: `Agent is not online (status: ${agent.status})` }, { status: 400 });\n    }\n    const envVars = {};\n    if (envContent) {\n      envContent.split(\"\\n\").forEach((line) => {\n        const trimmedLine = line.trim();\n        if (trimmedLine && !trimmedLine.startsWith(\"#\")) {\n          const [key, ...valueParts] = trimmedLine.split(\"=\");\n          if (key && valueParts.length > 0) {\n            envVars[key.trim()] = valueParts.join(\"=\").trim();\n          }\n        }\n      });\n    }\n    const createTask = await sendTaskToAgent(agentId, \"compose_create_project\", {\n      project_name: stackName,\n      compose_content: composeContent,\n      env_vars: envVars\n    });\n    console.log(`ðŸ“‹ Stack creation task ${createTask.id} created for agent ${agentId}: ${stackName}`);\n    const startTask = await sendTaskToAgent(agentId, \"compose_up\", {\n      project_name: stackName\n    });\n    console.log(`ðŸš€ Stack start task ${startTask.id} created for agent ${agentId}: ${stackName}`);\n    const deployment = await createStackDeployment(agentId, stackName, composeContent, envContent, startTask.id);\n    return json({\n      success: true,\n      createTask,\n      startTask,\n      deployment,\n      message: `Stack \"${stackName}\" created and started on agent`\n    });\n  } catch (error) {\n    console.error(\"Error creating and starting stack:\", error);\n    return json(\n      {\n        error: error instanceof Error ? error.message : \"Failed to create and start stack\"\n      },\n      { status: 500 }\n    );\n  }\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":";;;;;;;;;;;AAEK,MAAC,IAAI,GAAG,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,KAAK;AACpD,EAAE,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,EAAE;AAC7C,IAAI,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,cAAc,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC3D;AACA,EAAE,IAAI;AACN,IAAI,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,IAAI,EAAE;AACrC,IAAI,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO;AAClC,IAAI,MAAM,EAAE,SAAS,EAAE,cAAc,EAAE,UAAU,EAAE,IAAI,EAAE,GAAG,IAAI;AAChE,IAAI,IAAI,CAAC,SAAS,IAAI,CAAC,cAAc,EAAE;AACvC,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,6CAA6C,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC5F;AACA,IAAI,MAAM,KAAK,GAAG,MAAM,QAAQ,CAAC,OAAO,CAAC;AACzC,IAAI,IAAI,CAAC,KAAK,EAAE;AAChB,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAChE;AACA,IAAI,IAAI,KAAK,CAAC,MAAM,KAAK,QAAQ,EAAE;AACnC,MAAM,OAAO,IAAI,CAAC,EAAE,KAAK,EAAE,CAAC,6BAA6B,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;AAC9F;AACA,IAAI,MAAM,OAAO,GAAG,EAAE;AACtB,IAAI,IAAI,UAAU,EAAE;AACpB,MAAM,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,CAAC,IAAI,KAAK;AAC/C,QAAQ,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,EAAE;AACvC,QAAQ,IAAI,WAAW,IAAI,CAAC,WAAW,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;AACzD,UAAU,MAAM,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC,GAAG,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC;AAC7D,UAAU,IAAI,GAAG,IAAI,UAAU,CAAC,MAAM,GAAG,CAAC,EAAE;AAC5C,YAAY,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,GAAG,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE;AAC7D;AACA;AACA,OAAO,CAAC;AACR;AACA,IAAI,MAAM,UAAU,GAAG,MAAM,eAAe,CAAC,OAAO,EAAE,wBAAwB,EAAE;AAChF,MAAM,YAAY,EAAE,SAAS;AAC7B,MAAM,eAAe,EAAE,cAAc;AACrC,MAAM,QAAQ,EAAE;AAChB,KAAK,CAAC;AACN,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC,uBAAuB,EAAE,UAAU,CAAC,EAAE,CAAC,mBAAmB,EAAE,OAAO,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC;AACrG,IAAI,MAAM,SAAS,GAAG,MAAM,eAAe,CAAC,OAAO,EAAE,YAAY,EAAE;AACnE,MAAM,YAAY,EAAE;AACpB,KAAK,CAAC;AACN,IAAI,OAAO,CAAC,GAAG,CAAC,CAAC,oBAAoB,EAAE,SAAS,CAAC,EAAE,CAAC,mBAAmB,EAAE,OAAO,CAAC,EAAE,EAAE,SAAS,CAAC,CAAC,CAAC;AACjG,IAAI,MAAM,UAAU,GAAG,MAAM,qBAAqB,CAAC,OAAO,EAAE,SAAS,EAAE,cAAc,EAAE,UAAU,EAAE,SAAS,CAAC,EAAE,CAAC;AAChH,IAAI,OAAO,IAAI,CAAC;AAChB,MAAM,OAAO,EAAE,IAAI;AACnB,MAAM,UAAU;AAChB,MAAM,SAAS;AACf,MAAM,UAAU;AAChB,MAAM,OAAO,EAAE,CAAC,OAAO,EAAE,SAAS,CAAC,8BAA8B;AACjE,KAAK,CAAC;AACN,GAAG,CAAC,OAAO,KAAK,EAAE;AAClB,IAAI,OAAO,CAAC,KAAK,CAAC,oCAAoC,EAAE,KAAK,CAAC;AAC9D,IAAI,OAAO,IAAI;AACf,MAAM;AACN,QAAQ,KAAK,EAAE,KAAK,YAAY,KAAK,GAAG,KAAK,CAAC,OAAO,GAAG;AACxD,OAAO;AACP,MAAM,EAAE,MAAM,EAAE,GAAG;AACnB,KAAK;AACL;AACA;;;;"}