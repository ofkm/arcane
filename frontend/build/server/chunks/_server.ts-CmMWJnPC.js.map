{"version":3,"file":"_server.ts-CmMWJnPC.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/containers/_containerId_/logs/stream/_server.ts.js"],"sourcesContent":["import { e as error } from \"../../../../../../../chunks/index.js\";\nimport { g as getDockerClient } from \"../../../../../../../chunks/core.js\";\nimport { Writable } from \"stream\";\nconst GET = async ({ params, request }) => {\n  const { containerId } = params;\n  if (!containerId) {\n    throw error(400, \"Container ID is required\");\n  }\n  try {\n    const docker = await getDockerClient();\n    const container = docker.getContainer(containerId);\n    await container.inspect();\n    const stream = new ReadableStream({\n      start(controller) {\n        const encoder = new TextEncoder();\n        let isClosed = false;\n        let logStream = null;\n        const safeEnqueue = (data) => {\n          if (!isClosed) {\n            try {\n              controller.enqueue(encoder.encode(data));\n            } catch (err) {\n              isClosed = true;\n            }\n          }\n        };\n        const stdoutStream = new Writable({\n          write(chunk, encoding, callback) {\n            if (isClosed) {\n              callback();\n              return;\n            }\n            const message = chunk.toString();\n            const data = JSON.stringify({\n              level: \"stdout\",\n              message,\n              timestamp: (/* @__PURE__ */ new Date()).toISOString()\n            });\n            safeEnqueue(`data: ${data}\n\n`);\n            callback();\n          }\n        });\n        const stderrStream = new Writable({\n          write(chunk, encoding, callback) {\n            if (isClosed) {\n              callback();\n              return;\n            }\n            const message = chunk.toString();\n            const data = JSON.stringify({\n              level: \"stderr\",\n              message,\n              timestamp: (/* @__PURE__ */ new Date()).toISOString()\n            });\n            safeEnqueue(`data: ${data}\n\n`);\n            callback();\n          }\n        });\n        const cleanup = () => {\n          isClosed = true;\n          if (logStream) {\n            try {\n              if (typeof logStream.destroy === \"function\") {\n                logStream.destroy();\n              }\n            } catch (err) {\n            }\n          }\n        };\n        container.logs(\n          {\n            follow: true,\n            stdout: true,\n            stderr: true,\n            timestamps: true,\n            tail: 50\n          },\n          (err, stream2) => {\n            if (err) {\n              if (!isClosed) {\n                controller.error(err);\n              }\n              return;\n            }\n            logStream = stream2 || null;\n            if (stream2 && !isClosed) {\n              container.modem.demuxStream(stream2, stdoutStream, stderrStream);\n              stream2.on(\"end\", () => {\n                cleanup();\n                if (!isClosed) {\n                  controller.close();\n                }\n              });\n              stream2.on(\"error\", (streamErr) => {\n                cleanup();\n                if (!isClosed) {\n                  controller.error(streamErr);\n                }\n              });\n              stream2.on(\"close\", () => {\n                cleanup();\n              });\n            } else {\n              cleanup();\n            }\n          }\n        );\n        request.signal.addEventListener(\"abort\", () => {\n          cleanup();\n        });\n        return cleanup;\n      }\n    });\n    return new Response(stream, {\n      headers: {\n        \"Content-Type\": \"text/event-stream\",\n        \"Cache-Control\": \"no-cache\",\n        Connection: \"keep-alive\",\n        \"Access-Control-Allow-Origin\": \"*\",\n        \"Access-Control-Allow-Headers\": \"Cache-Control\"\n      }\n    });\n  } catch (err) {\n    throw error(500, \"Failed to stream container logs\");\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAGK,MAAC,GAAG,GAAG,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,KAAK;AAC3C,EAAE,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM;AAChC,EAAE,IAAI,CAAC,WAAW,EAAE;AACpB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,0BAA0B,CAAC;AAChD;AACA,EAAE,IAAI;AACN,IAAI,MAAM,MAAM,GAAG,MAAM,eAAe,EAAE;AAC1C,IAAI,MAAM,SAAS,GAAG,MAAM,CAAC,YAAY,CAAC,WAAW,CAAC;AACtD,IAAI,MAAM,SAAS,CAAC,OAAO,EAAE;AAC7B,IAAI,MAAM,MAAM,GAAG,IAAI,cAAc,CAAC;AACtC,MAAM,KAAK,CAAC,UAAU,EAAE;AACxB,QAAQ,MAAM,OAAO,GAAG,IAAI,WAAW,EAAE;AACzC,QAAQ,IAAI,QAAQ,GAAG,KAAK;AAC5B,QAAQ,IAAI,SAAS,GAAG,IAAI;AAC5B,QAAQ,MAAM,WAAW,GAAG,CAAC,IAAI,KAAK;AACtC,UAAU,IAAI,CAAC,QAAQ,EAAE;AACzB,YAAY,IAAI;AAChB,cAAc,UAAU,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AACtD,aAAa,CAAC,OAAO,GAAG,EAAE;AAC1B,cAAc,QAAQ,GAAG,IAAI;AAC7B;AACA;AACA,SAAS;AACT,QAAQ,MAAM,YAAY,GAAG,IAAI,QAAQ,CAAC;AAC1C,UAAU,KAAK,CAAC,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE;AAC3C,YAAY,IAAI,QAAQ,EAAE;AAC1B,cAAc,QAAQ,EAAE;AACxB,cAAc;AACd;AACA,YAAY,MAAM,OAAO,GAAG,KAAK,CAAC,QAAQ,EAAE;AAC5C,YAAY,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC;AACxC,cAAc,KAAK,EAAE,QAAQ;AAC7B,cAAc,OAAO;AACrB,cAAc,SAAS,EAAE,iBAAiB,IAAI,IAAI,EAAE,EAAE,WAAW;AACjE,aAAa,CAAC;AACd,YAAY,WAAW,CAAC,CAAC,MAAM,EAAE,IAAI;;AAErC,CAAC,CAAC;AACF,YAAY,QAAQ,EAAE;AACtB;AACA,SAAS,CAAC;AACV,QAAQ,MAAM,YAAY,GAAG,IAAI,QAAQ,CAAC;AAC1C,UAAU,KAAK,CAAC,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE;AAC3C,YAAY,IAAI,QAAQ,EAAE;AAC1B,cAAc,QAAQ,EAAE;AACxB,cAAc;AACd;AACA,YAAY,MAAM,OAAO,GAAG,KAAK,CAAC,QAAQ,EAAE;AAC5C,YAAY,MAAM,IAAI,GAAG,IAAI,CAAC,SAAS,CAAC;AACxC,cAAc,KAAK,EAAE,QAAQ;AAC7B,cAAc,OAAO;AACrB,cAAc,SAAS,EAAE,iBAAiB,IAAI,IAAI,EAAE,EAAE,WAAW;AACjE,aAAa,CAAC;AACd,YAAY,WAAW,CAAC,CAAC,MAAM,EAAE,IAAI;;AAErC,CAAC,CAAC;AACF,YAAY,QAAQ,EAAE;AACtB;AACA,SAAS,CAAC;AACV,QAAQ,MAAM,OAAO,GAAG,MAAM;AAC9B,UAAU,QAAQ,GAAG,IAAI;AACzB,UAAU,IAAI,SAAS,EAAE;AACzB,YAAY,IAAI;AAChB,cAAc,IAAI,OAAO,SAAS,CAAC,OAAO,KAAK,UAAU,EAAE;AAC3D,gBAAgB,SAAS,CAAC,OAAO,EAAE;AACnC;AACA,aAAa,CAAC,OAAO,GAAG,EAAE;AAC1B;AACA;AACA,SAAS;AACT,QAAQ,SAAS,CAAC,IAAI;AACtB,UAAU;AACV,YAAY,MAAM,EAAE,IAAI;AACxB,YAAY,MAAM,EAAE,IAAI;AACxB,YAAY,MAAM,EAAE,IAAI;AACxB,YAAY,UAAU,EAAE,IAAI;AAC5B,YAAY,IAAI,EAAE;AAClB,WAAW;AACX,UAAU,CAAC,GAAG,EAAE,OAAO,KAAK;AAC5B,YAAY,IAAI,GAAG,EAAE;AACrB,cAAc,IAAI,CAAC,QAAQ,EAAE;AAC7B,gBAAgB,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC;AACrC;AACA,cAAc;AACd;AACA,YAAY,SAAS,GAAG,OAAO,IAAI,IAAI;AACvC,YAAY,IAAI,OAAO,IAAI,CAAC,QAAQ,EAAE;AACtC,cAAc,SAAS,CAAC,KAAK,CAAC,WAAW,CAAC,OAAO,EAAE,YAAY,EAAE,YAAY,CAAC;AAC9E,cAAc,OAAO,CAAC,EAAE,CAAC,KAAK,EAAE,MAAM;AACtC,gBAAgB,OAAO,EAAE;AACzB,gBAAgB,IAAI,CAAC,QAAQ,EAAE;AAC/B,kBAAkB,UAAU,CAAC,KAAK,EAAE;AACpC;AACA,eAAe,CAAC;AAChB,cAAc,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,CAAC,SAAS,KAAK;AACjD,gBAAgB,OAAO,EAAE;AACzB,gBAAgB,IAAI,CAAC,QAAQ,EAAE;AAC/B,kBAAkB,UAAU,CAAC,KAAK,CAAC,SAAS,CAAC;AAC7C;AACA,eAAe,CAAC;AAChB,cAAc,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE,MAAM;AACxC,gBAAgB,OAAO,EAAE;AACzB,eAAe,CAAC;AAChB,aAAa,MAAM;AACnB,cAAc,OAAO,EAAE;AACvB;AACA;AACA,SAAS;AACT,QAAQ,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAM;AACvD,UAAU,OAAO,EAAE;AACnB,SAAS,CAAC;AACV,QAAQ,OAAO,OAAO;AACtB;AACA,KAAK,CAAC;AACN,IAAI,OAAO,IAAI,QAAQ,CAAC,MAAM,EAAE;AAChC,MAAM,OAAO,EAAE;AACf,QAAQ,cAAc,EAAE,mBAAmB;AAC3C,QAAQ,eAAe,EAAE,UAAU;AACnC,QAAQ,UAAU,EAAE,YAAY;AAChC,QAAQ,6BAA6B,EAAE,GAAG;AAC1C,QAAQ,8BAA8B,EAAE;AACxC;AACA,KAAK,CAAC;AACN,GAAG,CAAC,OAAO,GAAG,EAAE;AAChB,IAAI,MAAM,KAAK,CAAC,GAAG,EAAE,iCAAiC,CAAC;AACvD;AACA;;;;"}