{"version":3,"file":"_server.ts-Cxx6Neti.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/images/pull/_...name_/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../../chunks/index.js\";\nimport { p as pullImage } from \"../../../../../../chunks/image-service.js\";\nimport { A as ApiErrorCode } from \"../../../../../../chunks/errors.type.js\";\nimport { e as extractDockerErrorMessage } from \"../../../../../../chunks/errors.util.js\";\nimport { t as tryCatch } from \"../../../../../../chunks/try-catch.js\";\nimport { g as getSettings } from \"../../../../../../chunks/settings-service.js\";\nimport { a as areRegistriesEquivalent } from \"../../../../../../chunks/registry.utils.js\";\nconst POST = async ({ params, request }) => {\n  const fullPath = params.name;\n  if (!fullPath) {\n    const response = {\n      success: false,\n      error: \"Image reference is required\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  let body;\n  try {\n    body = await request.json();\n  } catch (error) {\n    const response = {\n      success: false,\n      error: \"Invalid request body\",\n      code: ApiErrorCode.BAD_REQUEST\n    };\n    return json(response, { status: 400 });\n  }\n  const platform = body?.platform;\n  const tag = body?.tag || \"latest\";\n  const imageRef = fullPath.includes(\":\") ? fullPath : `${fullPath}:${tag}`;\n  const imageName = imageRef.split(\":\")[0];\n  const imageRegistryHost = imageName.includes(\"/\") ? imageName.split(\"/\")[0].includes(\".\") || imageName.split(\"/\")[0].includes(\":\") ? imageName.split(\"/\")[0] : \"docker.io\" : \"docker.io\";\n  const authConfig = body?.auth || {};\n  let authOptions = {};\n  if (!authConfig.username && !authConfig.password) {\n    try {\n      const settings = await getSettings();\n      if (settings.registryCredentials && settings.registryCredentials.length > 0) {\n        const storedCredential = settings.registryCredentials.find((cred) => areRegistriesEquivalent(cred.url, imageRegistryHost));\n        if (storedCredential) {\n          console.log(`Using stored credentials for ${imageRegistryHost} as ${storedCredential.username}`);\n          const serverAddress = imageRegistryHost === \"docker.io\" ? \"https://index.docker.io/v1/\" : imageRegistryHost;\n          authOptions = {\n            username: storedCredential.username,\n            password: storedCredential.password,\n            serveraddress: serverAddress\n          };\n        } else if (imageRegistryHost !== \"docker.io\") {\n          console.log(`No stored credentials found for ${imageRegistryHost}. Attempting unauthenticated pull.`);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error loading authentication settings:\", error);\n    }\n  } else {\n    authOptions = authConfig;\n  }\n  console.log(`API: Pulling image \"${imageRef}\"...`);\n  const result = await tryCatch(pullImage(imageRef, platform, authOptions));\n  if (result.error) {\n    console.error(\"Error pulling image:\", result.error);\n    const response = {\n      success: false,\n      error: extractDockerErrorMessage(result.error),\n      code: ApiErrorCode.DOCKER_API_ERROR,\n      details: result.error\n    };\n    return json(response, { status: 500 });\n  }\n  return json({\n    success: true,\n    message: `Image \"${imageRef}\" pulled successfully.`\n  });\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}