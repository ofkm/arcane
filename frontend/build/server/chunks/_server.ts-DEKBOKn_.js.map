{"version":3,"file":"_server.ts-DEKBOKn_.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/auth/oidc/callback/_server.ts.js"],"sourcesContent":["import { r as redirect } from \"../../../../../chunks/index.js\";\nimport { OAuth2RequestError } from \"arctic\";\nimport { g as getOIDCClient, a as getOIDCTokenEndpoint, b as getOIDCUserinfoEndpoint } from \"../../../../../chunks/oidc-service.js\";\nimport { b as getUserByOidcSubjectId, g as getUserByUsername, s as saveUser } from \"../../../../../chunks/user-service.js\";\nimport { nanoid } from \"nanoid\";\nconst GET = async ({ url, cookies, locals }) => {\n  const code = url.searchParams.get(\"code\");\n  const state = url.searchParams.get(\"state\");\n  const storedState = cookies.get(\"oidc_state\");\n  const codeVerifier = cookies.get(\"oidc_code_verifier\");\n  const finalRedirectTo = cookies.get(\"oidc_redirect\") || \"/\";\n  cookies.delete(\"oidc_state\", { path: \"/\" });\n  cookies.delete(\"oidc_code_verifier\", { path: \"/\" });\n  cookies.delete(\"oidc_redirect\", { path: \"/\" });\n  if (!code || !state || !storedState || state !== storedState || !codeVerifier) {\n    console.error(\"OIDC callback error: state mismatch or missing params.\");\n    throw redirect(302, \"/auth/login?error=oidc_invalid_response\");\n  }\n  const oidcClient = await getOIDCClient();\n  const tokenEndpoint = await getOIDCTokenEndpoint();\n  const userinfoEndpoint = await getOIDCUserinfoEndpoint();\n  if (!oidcClient) {\n    console.error(\"OIDC client is not configured.\");\n    throw redirect(302, \"/auth/login?error=oidc_misconfigured\");\n  }\n  if (!tokenEndpoint) {\n    console.error(\"OIDC_TOKEN_ENDPOINT is not configured.\");\n    throw redirect(302, \"/auth/login?error=oidc_misconfigured\");\n  }\n  try {\n    const tokens = await oidcClient.validateAuthorizationCode(tokenEndpoint, code, codeVerifier);\n    if (!userinfoEndpoint) {\n      console.error(\"OIDC_USERINFO_ENDPOINT is not configured. Cannot fetch user details.\");\n      throw redirect(302, \"/auth/login?error=oidc_misconfigured\");\n    }\n    const userInfoResponse = await fetch(userinfoEndpoint, {\n      headers: {\n        Authorization: `Bearer ${tokens.accessToken()}`\n      }\n    });\n    if (!userInfoResponse.ok) {\n      console.error(\"Failed to fetch user info from OIDC provider:\", await userInfoResponse.text());\n      throw redirect(302, \"/auth/login?error=oidc_userinfo_failed\");\n    }\n    const oidcUser = await userInfoResponse.json();\n    const oidcSubjectId = oidcUser.sub;\n    const oidcUserEmail = oidcUser.email;\n    const oidcUserDisplayName = oidcUser.name || oidcUser.preferred_username;\n    const oidcUsername = oidcUser.preferred_username || oidcUser.email || `user-${oidcUser.sub?.slice(0, 8)}`;\n    if (!oidcSubjectId) {\n      console.error('OIDC userinfo response missing \"sub\" (subject identifier).');\n      throw redirect(302, \"/auth/login?error=oidc_missing_sub\");\n    }\n    let user = null;\n    let needsUpdate = false;\n    user = await getUserByOidcSubjectId(oidcSubjectId);\n    if (user) {\n      if (oidcUserDisplayName && user.displayName !== oidcUserDisplayName) {\n        user.displayName = oidcUserDisplayName;\n        needsUpdate = true;\n      }\n      if (oidcUserEmail && user.email !== oidcUserEmail) {\n        user.email = oidcUserEmail;\n        needsUpdate = true;\n      }\n      if (needsUpdate) {\n        user.updatedAt = (/* @__PURE__ */ new Date()).toISOString();\n      }\n    } else if (oidcUserEmail) {\n      const userByEmail = await getUserByUsername(oidcUserEmail);\n      if (userByEmail) {\n        if (!userByEmail.oidcSubjectId) {\n          userByEmail.oidcSubjectId = oidcSubjectId;\n          userByEmail.displayName = oidcUserDisplayName || userByEmail.displayName;\n          userByEmail.updatedAt = (/* @__PURE__ */ new Date()).toISOString();\n          user = userByEmail;\n          needsUpdate = true;\n        } else if (userByEmail.oidcSubjectId === oidcSubjectId) {\n          user = userByEmail;\n          if (oidcUserDisplayName && user.displayName !== oidcUserDisplayName) {\n            user.displayName = oidcUserDisplayName;\n            needsUpdate = true;\n          }\n          if (needsUpdate) {\n            user.updatedAt = (/* @__PURE__ */ new Date()).toISOString();\n          }\n        } else {\n          console.error(`OIDC login attempt for email ${oidcUserEmail} with new OIDC subjectId ${oidcSubjectId}, but email is already linked to OIDC subjectId ${userByEmail.oidcSubjectId}.`);\n          throw redirect(302, \"/auth/login?error=oidc_email_collision\");\n        }\n      }\n    }\n    if (!user) {\n      const newUser = {\n        id: nanoid(),\n        username: oidcUsername,\n        email: oidcUserEmail,\n        displayName: oidcUserDisplayName,\n        oidcSubjectId,\n        roles: [\"admin\"],\n        //This will be part of the rbac feature, user or admin doesnt really matter right now\n        createdAt: (/* @__PURE__ */ new Date()).toISOString(),\n        updatedAt: (/* @__PURE__ */ new Date()).toISOString(),\n        lastLogin: (/* @__PURE__ */ new Date()).toISOString()\n      };\n      user = newUser;\n      needsUpdate = true;\n    }\n    if (needsUpdate && user) {\n      await saveUser(user);\n    }\n    if (!user || !user.id || !user.username) {\n      console.error(\"Failed to retrieve or create user after OIDC auth.\");\n      throw redirect(302, \"/auth/login?error=user_processing_failed\");\n    }\n    if (user && !needsUpdate) {\n      user.lastLogin = (/* @__PURE__ */ new Date()).toISOString();\n      user.updatedAt = (/* @__PURE__ */ new Date()).toISOString();\n      await saveUser(user);\n    }\n    const userSession = {\n      userId: user.id,\n      username: user.username,\n      createdAt: Date.now(),\n      lastAccessed: Date.now()\n    };\n    await locals.session.set(userSession);\n    throw redirect(302, finalRedirectTo);\n  } catch (e) {\n    console.error(\"OIDC callback processing error:\", e);\n    if (e instanceof OAuth2RequestError) {\n      throw redirect(302, `/auth/login?error=oidc_token_error&code=${e.code || \"unknown\"}`);\n    }\n    if (e instanceof Error && e.message.includes(\"/auth/login?error=oidc_email_collision\")) {\n      throw e;\n    }\n    throw redirect(302, \"/auth/login?error=oidc_generic_error\");\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}