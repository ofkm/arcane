{"version":3,"file":"hooks.server-D27uDmgz.js","sources":["../../../.svelte-kit/adapter-node/chunks/hooks.server.js"],"sourcesContent":["import { r as redirect } from \"./index.js\";\nimport { b as building } from \"./environment.js\";\nimport { l as listUsers, h as hashPassword, s as saveUser, g as getUserByUsername } from \"./user-service.js\";\nimport { g as getSettings } from \"./settings-service.js\";\nimport { handleSession } from \"svelte-kit-cookie-session\";\nimport { createHash } from \"node:crypto\";\nimport { p as public_env } from \"./shared-server.js\";\nimport { d as dev } from \"./index5.js\";\nfunction sequence(...handlers) {\n  const length = handlers.length;\n  if (!length) return ({ event, resolve }) => resolve(event);\n  return ({ event, resolve }) => {\n    return apply_handle(0, event, {});\n    function apply_handle(i, event2, parent_options) {\n      const handle2 = handlers[i];\n      return handle2({\n        event: event2,\n        resolve: (event3, options) => {\n          const transformPageChunk = async ({ html, done }) => {\n            if (options?.transformPageChunk) {\n              html = await options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            if (parent_options?.transformPageChunk) {\n              html = await parent_options.transformPageChunk({ html, done }) ?? \"\";\n            }\n            return html;\n          };\n          const filterSerializedResponseHeaders = parent_options?.filterSerializedResponseHeaders ?? options?.filterSerializedResponseHeaders;\n          const preload = parent_options?.preload ?? options?.preload;\n          return i < length - 1 ? apply_handle(i + 1, event3, {\n            transformPageChunk,\n            filterSerializedResponseHeaders,\n            preload\n          }) : resolve(event3, { transformPageChunk, filterSerializedResponseHeaders, preload });\n        }\n      });\n    }\n  };\n}\nasync function checkFirstRun() {\n  try {\n    const users = await listUsers();\n    if (users.length === 0) {\n      console.log(\"No users found. Creating default admin user...\");\n      const passwordHash = await hashPassword(\"arcane-admin\");\n      await saveUser({\n        id: crypto.randomUUID(),\n        username: \"arcane\",\n        passwordHash,\n        displayName: \"Arcane Admin\",\n        email: \"arcane@local\",\n        roles: [\"admin\"],\n        createdAt: (/* @__PURE__ */ new Date()).toISOString()\n      });\n      console.log(\"Default admin user created successfully\");\n      console.log(\"Username: arcane\");\n      console.log(\"Password: arcane-admin\");\n      console.log(\"IMPORTANT: Please change this password immediately after first login!\");\n    }\n  } catch (error) {\n    console.error(\"Error during first-run check:\", error);\n  }\n}\nconst settings = await getSettings();\nconst sessionTimeout = settings.auth?.sessionTimeout || 1440;\nfunction createSecret(input) {\n  const hash = createHash(\"sha256\").update(input).digest();\n  return new Uint8Array(hash);\n}\nconst secretInput = public_env.PUBLIC_SESSION_SECRET;\nif (!secretInput) {\n  throw new Error(\"PUBLIC_SESSION_SECRET is missing in ENV.\");\n}\nconst secret = createSecret(secretInput);\nconst useSecureCookie = !(public_env.PUBLIC_ALLOW_INSECURE_COOKIES === \"true\" || dev);\nconst sessionHandler = handleSession({\n  secret,\n  expires: sessionTimeout * 60,\n  cookie: {\n    path: \"/\",\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: useSecureCookie\n  }\n});\nconst isTestEnvironment = process.env.APP_ENV === \"TEST\";\nif (!building) {\n  try {\n    const { runMigrations } = await import(\"./migrate.js\");\n    const { migrateSettingsToDatabase } = await import(\"./settings-db-service.js\");\n    const { migrateUsersToDatabase } = await import(\"./user-service.js\").then((n) => n.u);\n    const { migrateStacksToDatabase } = await import(\"./compose-db-service.js\");\n    const { initComposeService, stackRuntimeUpdater } = await import(\"./stack-custom-service.js\");\n    const { initAutoUpdateScheduler } = await import(\"./scheduler-service.js\");\n    const { initMaturityPollingScheduler } = await import(\"./image-service.js\").then((n) => n.e);\n    await runMigrations();\n    await Promise.all([migrateSettingsToDatabase(), migrateUsersToDatabase(), migrateStacksToDatabase()]);\n    await Promise.all([checkFirstRun(), initComposeService(), initAutoUpdateScheduler(), initMaturityPollingScheduler()]);\n    stackRuntimeUpdater.start(2);\n  } catch (err) {\n    console.error(\"Critical service init failed, exiting:\", err);\n    process.exit(1);\n  }\n}\nconst authHandler = async ({ event, resolve }) => {\n  if (building) {\n    return resolve(event);\n  }\n  const { url } = event;\n  const path = url.pathname;\n  const publicPaths = [\n    \"/auth/login\",\n    \"/img\",\n    \"/auth/oidc/login\",\n    \"/auth/oidc/callback\",\n    \"/api/agents/register\",\n    // Agent registration\n    \"/api/agents/heartbeat\"\n    // Agent heartbeat\n  ];\n  const agentPollingPattern = /^\\/api\\/agents\\/[^\\/]+\\/tasks$/;\n  const agentResultPattern = /^\\/api\\/agents\\/[^\\/]+\\/tasks\\/[^\\/]+\\/result$/;\n  const isPublicPath = publicPaths.some((p) => path.startsWith(p));\n  const isAgentPolling = agentPollingPattern.test(path) && event.request.method === \"GET\";\n  const isAgentResult = agentResultPattern.test(path) && event.request.method === \"POST\";\n  if (isPublicPath || isAgentPolling || isAgentResult) {\n    return await resolve(event);\n  }\n  const session = event.locals.session.data;\n  if (!session || !session.userId) {\n    await event.locals.session.destroy();\n    throw redirect(302, `/auth/login?redirect=${encodeURIComponent(path)}`);\n  }\n  if (!event.locals.user) {\n    try {\n      event.locals.user = await getUserByUsername(session.username);\n    } catch {\n      await event.locals.session.destroy();\n      throw redirect(302, `/auth/login?error=invalid-session`);\n    }\n  }\n  const user = event.locals.user;\n  if (!user) {\n    await event.locals.session.destroy();\n    throw redirect(302, `/auth/login?error=invalid-session`);\n  }\n  const settings2 = await getSettings();\n  const isOnboardingPath = path.startsWith(\"/onboarding\");\n  const isApiRoute = path.startsWith(\"/api/\");\n  if (!isTestEnvironment) {\n    if (!isOnboardingPath && !isApiRoute && !settings2?.onboarding?.completed) {\n      throw redirect(302, \"/onboarding/welcome\");\n    }\n    if (isApiRoute && !settings2?.onboarding?.completed) {\n      const allowedApiDuringOnboarding = [\"/api/settings\", \"/api/users/password\"];\n      const isAllowedApi = allowedApiDuringOnboarding.some((api) => path.startsWith(api));\n      if (!isAllowedApi) {\n        throw redirect(302, \"/onboarding/welcome\");\n      }\n    }\n  }\n  return await resolve(event);\n};\nconst handle = sequence(sessionHandler, authHandler);\nexport {\n  handle\n};\n"],"names":[],"mappings":"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"}