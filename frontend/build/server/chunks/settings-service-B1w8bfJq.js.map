{"version":3,"file":"settings-service-B1w8bfJq.js","sources":["../../../.svelte-kit/adapter-node/chunks/settings-service.js"],"sourcesContent":["import \"proper-lockfile\";\nimport \"./encryption-service.js\";\nimport { S as STACKS_DIR, e as ensureDirectory } from \"./schema.js\";\nimport { getSettingsFromDb, saveSettingsToDb } from \"./settings-db-service.js\";\nlet env;\ntry {\n  env = await import(\"./private.js\");\n} catch (e) {\n  env = process.env;\n}\nconst isDev = process.env.NODE_ENV === \"development\";\nconst DEFAULT_SETTINGS = {\n  dockerHost: isDev ? process.platform === \"win32\" ? \"npipe:////./pipe/docker_engine\" : \"unix:///var/run/docker.sock\" : \"unix:///var/run/docker.sock\",\n  autoUpdate: false,\n  autoUpdateInterval: 5,\n  pollingEnabled: true,\n  pollingInterval: 10,\n  pruneMode: \"all\",\n  stacksDirectory: STACKS_DIR,\n  registryCredentials: [],\n  templateRegistries: [],\n  auth: {\n    localAuthEnabled: true,\n    oidcEnabled: false,\n    sessionTimeout: 60,\n    passwordPolicy: \"strong\",\n    rbacEnabled: false\n  },\n  maturityThresholdDays: 30\n};\nasync function ensureStacksDirectory() {\n  try {\n    const settings = await getSettings();\n    const stacksDir = settings.stacksDirectory;\n    await ensureDirectory(stacksDir);\n    return stacksDir;\n  } catch (err) {\n    console.error(\"Error ensuring stacks directory:\", err);\n    try {\n      await ensureDirectory(STACKS_DIR);\n      return STACKS_DIR;\n    } catch (innerErr) {\n      console.error(\"Failed to create default stacks directory:\", innerErr);\n      throw new Error(\"Unable to create stacks directory\");\n    }\n  }\n}\nasync function getSettings() {\n  try {\n    const dbSettings = await getSettingsFromDb();\n    let effectiveSettings;\n    if (dbSettings) {\n      effectiveSettings = dbSettings;\n    } else {\n      console.log(\"No settings found in database, using default settings\");\n      effectiveSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));\n    }\n    const oidcClientId = env.OIDC_CLIENT_ID;\n    const oidcClientSecret = env.OIDC_CLIENT_SECRET;\n    const oidcRedirectUri = env.OIDC_REDIRECT_URI;\n    const oidcAuthorizationEndpoint = env.OIDC_AUTHORIZATION_ENDPOINT;\n    const oidcTokenEndpoint = env.OIDC_TOKEN_ENDPOINT;\n    const oidcUserinfoEndpoint = env.OIDC_USERINFO_ENDPOINT;\n    const oidcScopesEnv = env.OIDC_SCOPES;\n    if (oidcClientId && oidcClientSecret && oidcRedirectUri && oidcAuthorizationEndpoint && oidcTokenEndpoint && oidcUserinfoEndpoint) {\n      if (!effectiveSettings.auth) {\n        effectiveSettings.auth = JSON.parse(JSON.stringify(DEFAULT_SETTINGS.auth));\n      }\n      const oidcConfigFromEnv = {\n        clientId: oidcClientId,\n        clientSecret: oidcClientSecret,\n        redirectUri: oidcRedirectUri,\n        authorizationEndpoint: oidcAuthorizationEndpoint,\n        tokenEndpoint: oidcTokenEndpoint,\n        userinfoEndpoint: oidcUserinfoEndpoint,\n        scopes: oidcScopesEnv || effectiveSettings.auth.oidc?.scopes || DEFAULT_SETTINGS.auth.oidc?.scopes || \"openid email profile\"\n      };\n      effectiveSettings.auth.oidc = oidcConfigFromEnv;\n    }\n    return effectiveSettings;\n  } catch (error) {\n    console.error(\"Error getting settings from database, falling back to defaults:\", error);\n    return JSON.parse(JSON.stringify(DEFAULT_SETTINGS));\n  }\n}\nasync function saveSettings(settings) {\n  try {\n    await saveSettingsToDb(settings);\n    console.log(\"Settings saved to database successfully\");\n  } catch (error) {\n    console.error(\"Error saving settings to database:\", error);\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    throw new Error(`Failed to save settings: ${errorMessage}`);\n  }\n}\nexport {\n  ensureStacksDirectory as e,\n  getSettings as g,\n  saveSettings as s\n};\n"],"names":[],"mappings":"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"}